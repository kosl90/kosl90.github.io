<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Bit Getter and Setter &#8211; kosl90's Blog</title>
<meta name="description" content="a simple bit getter and setter">
<meta name="keywords" content="c, cpp, c++, bit-operation">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/abstract-6.jpg">

<meta name="twitter:title" content="Bit Getter and Setter">
<meta name="twitter:description" content="a simple bit getter and setter">
<meta name="twitter:creator" content="@kosl90">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Bit Getter and Setter">
<meta property="og:description" content="a simple bit getter and setter">
<meta property="og:url" content="/bit-getter-and-setter">
<meta property="og:site_name" content="kosl90's Blog">





<link rel="canonical" href="/bit-getter-and-setter">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="kosl90's Blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.min.css">
<!-- Webfonts -->
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




<style type="text/css">body {background-image:url(/images/retina_dust.png);}</style>


</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Lee photo" class="author-photo">
					<h4>Lee</h4>
					<p>Be gentle, be patient, be a man.</p>
				</li>
				<li><a href="/about/">Learn More</a></li>
				<li>
					<a href="mailto:kos1990l@gmail.com"><i class="fa fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/kosl90"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://facebook.com/kosl90"><i class="fa fa-facebook"></i> Facebook</a>
				</li>
				
				
				<li>
					<a href="http://github.com/kosl90"><i class="fa fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
                <li>
                    <a href="#">Links</a>
                    <ul class="dl-submenu">
                        <li><a href="http://randomk.gitcafe.com">RandomK</a></li>
                    
                        <li><a href="http://blog.csdn.net/kosl90">Old Blog</a></li>
                    </ul>
                </li>
                <li><a href="/feed.xml">Feed</a></li>
        </ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="/images/abstract-6.jpg" alt="Bit Getter and Setter">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/bit-getter-and-setter" rel="bookmark" title="Bit Getter and Setter">Bit Getter and Setter</a></h1>
        
        <h2>March 09, 2014</h2>
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>昨天周六，下午把床晒了晒，在晒床的时候呢，我则躺在沙发上看了看《算法精解》，正好看到位运算。里面有两个简单的操作，
一个是对某一位设1/0，另一个则是获取某一位是1/0。当时的直觉是，代码写的简单直白，应该还有更高效的处理方法。</p>

<p>虽然这个想法仅仅是在脑海中一闪而过，但是晚上正好在C++吧看到<a href="http://tieba.baidu.com/p/2900558125">一篇帖子</a>，
楼主提出了类似的写法，并称该算法效率太差，希望高手指教。</p>

<p>进去看了看，首先看到的是楼主说即使将mask存入数组，可还是太慢。另外有人给出了一段简单的代码片段，楼主根据这个代码片段写了一个简单的宏：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define SetBit(LPByte,BitPlace,BitValue) ( BitValue==0? (*LPByte)&amp;=~(1&lt;&lt;(BitPlace-1)) : (*LPByte)|=(1&lt;&lt;(BitPlace-1)));
</span></code></pre></div>
<p>代码很简单，首先判断要设的值是1还是0，然后根据这个值来对1进行位移等位操作然后根据不同的值使用其他位操作来对特定的位设值。
不过根据评论，似乎对性能没有多大的影响。看到这段代码的感觉是，应该可以不用判断BitValue的值，而是对BitValue进行某些位操作来得到某个值，
之后使用这个值与LPByte进行一定位操作之后的结果进行某个位操作之后即可得到正确的值。果然，楼主在楼下提出了另一段代码，实现了我所想的方案：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define SetBit(LPByte,BitPlace,BitValue) ( (*LPByte) = ( (*LPByte)&amp;~(1&lt;&lt;(BitPlace-1) ))|(BitValue&lt;&lt;(BitPlace-1)) );
</span>
<span class="cp">#define GetBit(LPByte,BitPlace,BitValue) ( BitValue=((*LPByte)&amp;(1&lt;&lt;(BitPlace-1)))&gt;&gt;(BitPlace-1) );
</span></code></pre></div>
<p>宏看起来都比较麻烦，而且这段宏还存在着一定的问题，为了方便我将其整理成为了一下代码：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">set_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>这段宏改编的代码很简单，而且所采用的思想其实也很简单，对于set_bit函数来说，首先通过对1的位移和取反，然后与b进行与操作将该位置为0，
然后对value进行位移，之后再与之前清空后的结果进行或操作得到最后的结果。类似的，get_bit函数则是与set_bit函数相反，将其他位置位0而保留需要获取的位，
之后将其位移得到最后的结果。后来楼主又贴出了另外一段对n位进行处理的代码：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define GetNBit (LPByte,Begin,End,BitValue) (BitValue=((*LPByte)&amp;((255&gt;&gt;(8-End))&amp;(255&lt;&lt;(Begin-1))))&gt;&gt;(Begin-1));
</span>
<span class="cp">#define SetNBit (LPByte,Begin,End,BitValue) (*LPByte)=((*LPByte)&amp;(~((255&gt;&gt;(8-End))&amp;(255&lt;&lt;(Begin-1)))))|(BitValue&lt;&lt;(Begin-1));
</span></code></pre></div>
<p>这段代码就不改写了，原理和之前的是一样的。当然，还有人提到了内联汇编，使用BT/BTS之类的命令，不过我觉得已经没有必要了。
虽然我不是很懂汇编，也没有测试，不过我对使用这些带有测试的操作能够比直接通过简单的位操作来得到结果更快持怀疑态度，
过段时间我想我会测试一下。</p>

<p>不过既然提到了汇编，而主题又是位移什么的，不禁让我想起了以前看《深入理解计算机系统》的日子，情不自禁的将代码生成汇编代码观察了一番，
代码比较简单，没什么值得多说的，值得一提的是参数和本地变量是通过ebp寄存器做偏移得到的，eax寄存器则被频繁用于存储结果，并在最后用来
存储函数的返回值。而楼主以前使用switch很慢的原因，根据幻之上帝的说法是：要分支预测+间接操作慢个几十倍正常。</p>

<p>回头想一下，其实这些操作与思想都是很基础的，尤其是将对某一位进行保留和置1/0这几个操作可以说是基础中的基础。再次提醒自己，
不论做什么事情，基础都是最重要的，不要只看到别人的光鲜亮丽，要静下心来学习，打好基础，只有基础好了，才能够从基础中演变出各种犀利的东西。</p>

<p>参考资料（关于汇编的）：</p>

<ol>
<li><a href="https://www.cs.virginia.edu/%7Eevans/cs216/guides/x86.html">x86 Assembly Guide</a></li>
<li><a href="https://www.cse.nd.edu/%7Edthain/courses/cse40243/fall2008/ia32-intro.html">IA-32 Assembly for Compiler Writers</a></li>
<li><a href="https://cseweb.ucsd.edu/classes/sp10/cse141/pdf/02/S01_x86_64.key.pdf">A Readers Guide to x86 Assembly(pdf)</a></li>
<li><a href="http://www.cnblogs.com/justinyo/archive/2013/03/08/2950718.html">分析.cpp文件编译生成的汇编文件里语句的作用</a></li>
</ol>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#c" title="Pages tagged c" class="tag">c</a><a href="/tags/#cpp" title="Pages tagged cpp" class="tag">cpp</a><a href="/tags/#c++" title="Pages tagged c++" class="tag">c++</a><a href="/tags/#bit-operation" title="Pages tagged bit-operation" class="tag">bit-operation</a></span>
        <span><a href="/bit-getter-and-setter" rel="bookmark" title="Bit Getter and Setter">Bit Getter and Setter</a> was published on <span class="entry-date date published updated"><time datetime="2014-03-09T00:00:00+08:00">March 09, 2014</time></span></span>
        (revised: <span class="entry-date date modified"><time datetime="2014-03-09">03/09/2014</time></span>)
        <span class="author vcard"><span class="fn"><a href="/about/" title="About Lee">Lee</a></span></span>
        <div class="social-share">
          <ul class="socialcount socialcount-small inline-list">
            <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/bit-getter-and-setter" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
            <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/bit-getter-and-setter" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
            <li class="googleplus"><a href="https://plus.google.com/share?url=/bit-getter-and-setter" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
          </ul>
        </div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    
    <div class="read-more">
      
        <div class="read-more-header">
          <a href="/fix-newline-to-space" class="read-more-btn">Read More</a>
        </div><!-- /.read-more-header -->
        <div class="read-more-content">
          <h3><a href="/interview" title="2016找工作记1 - 一次面试的反思">2016找工作记1 - 一次面试的反思</a></h3>
          <p>2016找工作记1，一次面试的反思 <a href="/interview">Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="/golang-reflect-101" title="Golang Reflect 101">Golang Reflect 101</a></h4>
            <span>Published on June 20, 2014</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="/fix-newline-to-space" title="Fix Newline to Space">Fix Newline to Space</a></h4>
            <span>Published on February 23, 2014</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
      
    </div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Lee. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="/assets/js/vendor/echo.min.js"></script>
<script>Echo.init({offset:'200',throttle: 250});</script>
<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>
<script src="/assets/js/plugins/jquery.fancybox.pack.js"></script>
<script>(function($){$(".fancybox").fancybox();})(jQuery);</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-48343245-1', 'kosl90.github.io');
  ga('send', 'pageview');

</script>


<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'kosl90'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
 var s = document.createElement('script'); s.async = true;
 s.type = 'text/javascript';
 s.src = '//' + disqus_shortname + '.disqus.com/count.js';
 (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());

(function () {
//  window.addEventListener("load", function(){ if (window.location.hash === '#disqus_thread') loadComments(); });
 var a = document.createElement("a")
 a.setAttribute("class", "load-comments");
 a.setAttribute("href", "#disqus_thread");
 var d = document.getElementById("disqus_thread");
 d.appendChild(a);

 var disqus_loaded = false;
 function loadComments() {

 if (disqus_loaded)
 return;

 disqus_loaded = true;

 var s = document.getElementsByTagName('script')[0], sp = s.parentNode;
 var dsq = document.createElement('script');
 dsq.type = 'text/javascript';
 dsq.async = true;
 dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
 sp.insertBefore(dsq, s);
 }
 var loadCommentsButtons = document.querySelectorAll('.load-comments');
 for(var l = 0; l < loadCommentsButtons.length; l++) loadCommentsButtons[l].addEventListener('click', loadComments);
}());
</script>

	        

</body>
</html>
